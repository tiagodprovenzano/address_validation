# ---------- 1. Builder stage: install libpostal + node deps ----------
FROM ubuntu:22.04 AS builder

# Core tools
RUN apt-get update && apt-get install -y \
      build-essential curl git python3 python3-pip pkg-config \
      libtool autoconf automake wget ca-certificates

# Libpostal
RUN git clone https://github.com/openvenues/libpostal.git && \
    cd libpostal && ./bootstrap.sh && ./configure && make -j$(nproc) && make install && ldconfig

# Node dependencies
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# Python binding
RUN pip install postal fastapi uvicorn

# Copy source
COPY . .

# ---------- 2. Runtime stage: slim image with libs copied ----------
FROM ubuntu:22.04 AS runtime

# libpostal runtime files
COPY --from=builder /usr/local /usr/local
ENV LD_LIBRARY_PATH=/usr/local/lib

# Node runtime
RUN apt-get update && apt-get install -y nodejs npm python3

WORKDIR /app
COPY --from=builder /app /app

EXPOSE 3000
CMD ["npm","start"]